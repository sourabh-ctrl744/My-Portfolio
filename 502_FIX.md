# Fix 502 Bad Gateway Error

## ğŸ”´ Problem Identified

**502 Bad Gateway** = Backend application is NOT running

The nginx load balancer is up, but your Node.js app crashed or isn't starting.

## ğŸš¨ Most Likely Cause: Database Connection Failed

Your backend tries to connect to the database on startup. If it fails, the app exits with `process.exit(1)`.

## âœ… Fix Steps

### Step 1: Check Elastic Beanstalk Health & Logs

1. **Go to AWS Console** â†’ **Elastic Beanstalk** â†’ Your Environment
2. **Check Health Status:**
   - ğŸ”´ **Red** = App crashed
   - ğŸŸ¡ **Yellow** = Warning
   - ğŸŸ¢ **Green** = Running

3. **Check Logs:**
   - Click **Logs** â†’ **Request Logs** â†’ **Last 100 Lines**
   - Look for:
     - `âŒ DB connection failed: ...` â† **This is your problem**
     - `âœ… Database connected` â† Good
     - `âœ… API running` â† Good
     - Any error messages

### Step 2: Verify Environment Variables

1. **EB** â†’ **Configuration** â†’ **Software** â†’ **Environment properties**
2. **Verify these are set:**
   ```
   DATABASE_URL=postgresql://postgres:Xu4iU3hqrpGfvCt@portfolio-db.cri8q6us0qjl.ap-southeast-2.rds.amazonaws.com:5432/portfolio_db
   CLIENT_ORIGIN=http://portfolio-frontend-sourabh.s3-website-ap-southeast-2.amazonaws.com
   PORT=5002
   NODE_ENV=production
   ```

### Step 3: Check Database Connection

**The database connection is probably failing because:**

1. **RDS Security Group** doesn't allow EB security group
2. **DATABASE_URL** is wrong or not set
3. **Database doesn't exist** or credentials are wrong

**Fix RDS Security Group:**
1. Go to **RDS** â†’ Your database â†’ **Connectivity & security**
2. Click on **Security group** (VPC security groups)
3. Click **Edit inbound rules**
4. **Add rule:**
   - Type: **PostgreSQL**
   - Port: **5432**
   - Source: **Your EB environment's security group**
     - Or: Select the security group that starts with `awseb-...`
5. **Save rules**

**To find EB security group:**
- EB â†’ Configuration â†’ Instances â†’ Security groups
- Or: EC2 â†’ Security Groups â†’ Look for one with "elasticbeanstalk" in name

### Step 4: Run Database Migrations

If database connection works but tables don't exist:

1. **SSH into EB instance** (see `RUN_MIGRATIONS.md`)
2. **Run:**
   ```bash
   cd /var/app/current
   npm run db:migrate
   ```

### Step 5: Restart Environment

After fixing environment variables or security groups:

1. **EB** â†’ Your Environment â†’ **Actions** â†’ **Restart app server(s)**
2. Wait 2-5 minutes
3. Check health status again

## ğŸ” Quick Diagnostic Commands

### Check if DATABASE_URL is set in EB:
```bash
# Via EB Console â†’ Configuration â†’ Software â†’ Environment properties
# Or via AWS CLI:
aws elasticbeanstalk describe-configuration-settings \
  --application-name YOUR_APP_NAME \
  --environment-name YOUR_ENV_NAME \
  --region ap-southeast-2 \
  | grep DATABASE_URL
```

### Test Database Connection:
```bash
# From your local machine (if RDS is publicly accessible)
psql "postgresql://postgres:Xu4iU3hqrpGfvCt@portfolio-db.cri8q6us0qjl.ap-southeast-2.rds.amazonaws.com:5432/portfolio_db"

# Or from EB instance (SSH in first)
cd /var/app/current
psql $DATABASE_URL
```

## ğŸ“‹ Checklist

- [ ] Check EB Health Status (should be Green)
- [ ] Check EB Logs for error messages
- [ ] Verify `DATABASE_URL` is set in EB environment variables
- [ ] Verify RDS security group allows EB security group
- [ ] Test database connection
- [ ] Run migrations if tables don't exist
- [ ] Restart EB environment
- [ ] Test `/api/health` endpoint again

## ğŸ¯ Most Likely Fix

**99% chance it's one of these:**

1. **DATABASE_URL not set** in EB environment variables
2. **RDS security group** blocking EB security group
3. **Database tables don't exist** (need to run migrations)

## ğŸš€ After Fix

Once backend is running:
1. Test: `curl http://portfolio-backend-env.eba-hbcrd6cy.ap-southeast-2.elasticbeanstalk.com/api/health`
2. Should return: `{"ok":true,"time":"..."}`
3. Then fix CORS (set CLIENT_ORIGIN)
4. Then test your frontend

